@model ApimGuard.Models.ApiInfo

@{
    ViewData["Title"] = "API Details";
}

<h1>API Details</h1>

<div class="card">
    <div class="card-body">
        <h5 class="card-title">@Model.DisplayName</h5>
        <dl class="row">
            <dt class="col-sm-3">ID</dt>
            <dd class="col-sm-9">@Model.Id</dd>

            <dt class="col-sm-3">Name</dt>
            <dd class="col-sm-9">@Model.Name</dd>

            <dt class="col-sm-3">Path</dt>
            <dd class="col-sm-9">@Model.Path</dd>

            <dt class="col-sm-3">Service URL</dt>
            <dd class="col-sm-9">@Model.ServiceUrl</dd>

            <dt class="col-sm-3">Description</dt>
            <dd class="col-sm-9">@(Model.Description ?? "N/A")</dd>

            <dt class="col-sm-3">Protocols</dt>
            <dd class="col-sm-9">@string.Join(", ", Model.Protocols)</dd>
        </dl>
    </div>
</div>

<div class="card mt-3">
    <div class="card-body">
        <h5 class="card-title">Security Details</h5>
        <dl class="row">
            <dt class="col-sm-3">Subscription Required</dt>
            <dd class="col-sm-9">
                @if (Model.SubscriptionRequired)
                {
                    <span class="badge bg-warning text-dark">Yes</span>
                }
                else
                {
                    <span class="badge bg-secondary">No</span>
                }
            </dd>

            <dt class="col-sm-3">Azure AD Token Validation</dt>
            <dd class="col-sm-9">
                @if (Model.AzureAdClientApplicationIds.Any())
                {
                    <span class="badge bg-success">Enabled</span>
                    <div class="mt-2">
                        <strong>Configured Client Application IDs:</strong>
                        <ul class="mt-1">
                            @foreach (var appId in Model.AzureAdClientApplicationIds)
                            {
                                <li>
                                    <a asp-controller="AppRegistrations" asp-action="DetailsByAppId" asp-route-appId="@appId" class="text-decoration-none">
                                        <code>@appId</code>
                                    </a>
                                </li>
                            }
                        </ul>
                    </div>
                }
                else
                {
                    <span class="badge bg-secondary">Not configured</span>
                }
            </dd>
        </dl>
    </div>
</div>

<div class="mt-3">
    <a asp-action="Index" class="btn btn-secondary">Back to List</a>
    <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">Delete</a>
</div>

<br />

<div class="mt-4">
    <h3>API Documentation</h3>
    <div id="redoc-container"></div>
    <div id="no-definition-message" style="display: none;" class="alert alert-info">
        No API definition available for this API.
    </div>
</div>

@section Scripts {
    <script src="https://cdn.redoc.ly/redoc/latest/bundles/redoc.standalone.js"></script>
    <script>
        // Fetch and display the API definition using Redoc
        fetch('@Url.Action("GetDefinition", "ApiManagement", new { id = Model.Id })')
            .then(response => {
                if (!response.ok) {
                    throw new Error('API definition not found');
                }
                return response.json();
            })
            .then(spec => {
                // Initialize Redoc with the API specification
                Redoc.init(spec, {
                    scrollYOffset: 50,
                    hideDownloadButton: false,
                    theme: {
                        colors: {
                            primary: {
                                main: '#0d6efd'
                            }
                        }
                    }
                }, document.getElementById('redoc-container'));
            })
            .catch(error => {
                console.error('Error loading API definition:', error);
                document.getElementById('no-definition-message').style.display = 'block';
            });
    </script>
}
